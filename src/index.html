<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webpack-minimal</title>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon-16x16.png"/>
    <link href="./assets/cards-css/zynga.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <style>
     html, body {
         width: 100%;
         height: 100%;
         padding: 0px;
         margin: 0px;
     }

     body {
         font-family: 'Roboto', sans-serif;
         background: black;
     }

     section {
         width: 100%;
         height: 100%;
         background: #202020;
     }

     #app {
         position: relative;
         width: 120vmin;
         height: 60vmin;
         margin: auto;
     }

     #controls {
         margin: 10px auto;
         display: flex;
         justify-content: center;
     }

     #controls > * {
         margin: 0px 4px;
     }

    </style>
</head>
<body>
  <section>
    <div id="app" class="is2d"></div>
    <div id="controls">
      <button id="deal">Deal</button>
      <button id="join">Join</button>
      <button id="leave">Leave</button>
    </div>
  </section>

  <script>

   Tetris.Tests();
   init();

   function ServerContext() {
     const avatar = (() => {
       let id = 0;
       return function() {
         return 'https://i.pravatar.cc/300?' + (id++);
       }
     })();

     const seat = () => ({
       img: avatar()
     });

     const dealFens = {
       5: ['60b 40s 100B 100n 100!20(. 5 10 . .)~10!0\n',
           '70 50b 100s 100B 100n!20(. . 5 10 .)~10!0\n'],
       4: ['70B 50n 100b 100s!20(10 . . 5)~10!0\n'],
       3: ['70s 50B 100bn!20(5 10 .)~10!0\n'],
       2: ['70B, 100bsn!20(10 5)~10!0\n',
           '70bsn 100B!20(5 10)~10!0\n'],
     };

     let fen = '70b 50!0(. .)~10!0\n';

     let seats = [
       seat(),
       seat(),
       seat(),
       seat(),
       seat()
     ];

     let events = {
       sit: onSit,
       flag: onFlag
     };

     let clock = {
       running: true,
       initial: 60,
       times: 60
     };

     function onSit(seatIndex) {
       console.log(seatIndex);
     }

     function onFlag() {
       console.log('onFlag');
     }

     function seatsLength() {
       let res = 0;
       for (let i = 0; i < seats.length; i++) {
         if (seats[i]) res++;
       }
       return res;
     }

     function seatIndexes(count) {
       let res = [];
       for (let i = 0; i < seats.length; i++) {
         if (res.length === count) break;

         if (seats[i]) {
           res.push(i);
         }
       }
       return res;
     }

     function emptyIndex() {
       for (let i = 0; i < seats.length; i++) {
         if (!seats[i]) return i;
       }
       return null;
     }

     this.get = () => ({
       fen,
       clock,
       seats,
       events,
       seatIndexes: seatIndexes(2)
     });

     this.deal = () => {
       let fens = dealFens[seatsLength()];

       if (!fens) {
         return null;
       }

       let fen = fens[Math.floor(Math.random() * fens.length)];

       return {
         fen,
         seatIndexes: seatIndexes(seatsLength())
       };
     };

     this.join = () => {
       let seatIndex = emptyIndex();
       return {
         seatIndex,
         seat: seat()
       };
     };

     this.leave = () => {
       let seatIndex = seatIndexes(seatsLength())[0];

       if (seatIndex === null) {
         return null;
       }

       return {
         seatIndex
       };
     };
   }


   function init() {

     let context = new ServerContext();

     let api = Tetris(document.getElementById('app'), {
       ...context.get()
     });

     onClick(document.getElementById('deal'), apiDeal(context,
                                                      api));

     onClick(document.getElementById('join'), apiJoin(context,
                                                      api));

     onClick(document.getElementById('leave'), apiLeave(context,
                                                        api));

   }

   function apiJoin(context, api) {
     return function() {
       let oJoin = context.join();
       if (oJoin) {
         return api.join(oJoin);
       }
       return Promise.reject();
     };
   }

   function apiLeave(context, api) {
     return function() {
       let oLeave = context.leave();
       if (oLeave) {
         return api.leave(oLeave);
       }
       return Promise.reject();
     };
   }

   function apiDeal(context, api) {
     return function() {
       let oDeal = context.deal();
       if (oDeal) {
         return api.deal(oDeal);
       }
       return Promise.reject();
     };
   }

   function onClick(element, f) {
     element.addEventListener('click', f);
   }
   
  </script>

</body>
</html>
